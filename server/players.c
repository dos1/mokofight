#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "players.h"

Player* findPlayerById(PlayerList *list, int id) {
  while (list) {
    if (list->player->id == id) {
      return list->player;
    }
    list = list->next;
  }
  return NULL;
}

Player* findPlayerByName(PlayerList *list, char* name) {
  if (!name) return NULL;
  while (list) {
    if (list->player->name && strncmp(name, list->player->name, 5) == 0) {
      return list->player;
    }
    list = list->next;
  }
  return NULL;
}

PlayerList* addPlayer(PlayerList *list, int id) {
  Player *player = malloc(sizeof(Player));
  player->id = id;
  player->name = NULL;
  player->opponent = NULL;
  player->spectator = false;
  player->position = 0;
  player->hp = 0;
  
  player->_state.join = 0;
  player->_state.position = 0;
  player->_state.attack = 0;
  player->_state.moko = 0;
  
  PlayerList *elem = malloc(sizeof(PlayerList));
  elem->player = player;
  elem->next = NULL;
  
  if (list) {
    PlayerList *pom = list;
    while (pom->next) {
      pom = pom->next;
    }
    pom->next = elem;
    return list;
  } else {
    return elem;
  }
}

static void _freePlayerListEntry(PlayerList *entry) {
  if (entry->player->name) {
    free(entry->player->name);
  }
  if (entry->player->opponent) {
    free(entry->player->opponent);
  }
  free(entry->player);
}

PlayerList *deletePlayerById(PlayerList *list, int id) {
  PlayerList *first = list;
  
  if (list->player->id == id) {
    PlayerList *pom = list->next;
    leaveGame(first, id);
    _freePlayerListEntry(list);
    free(list);
    return pom;
  }
  
  while (list->next) {
    if (list->next->player->id == id) {
      PlayerList *pom = list->next;
      list->next = list->next->next;
      
      leaveGame(first, id);
      _freePlayerListEntry(pom);
      free(pom);

      return first;
    }
    list = list->next;
  }
  return first;
}

bool joinGame(PlayerList *list, int playerId, char* game) {
  
  Player *player = findPlayerById(list, playerId); // TODO: error handling
  
  if (!player) {
    printf("joinGame: tried to join non-existent player %d!!!\n", playerId);
    return false;
  }
  
  if (player->opponent) {
    free(player->opponent);
  }
  player->opponent = strdup(game);
  
  Player *opponent = findPlayerByName(list, game); // TODO: error handling
  
  if (opponent && opponent->opponent && player->name && strncmp(opponent->opponent, player->name, 5) == 0) {
    // game is joined mutually - let the game begin!
    player->inGame = true;
    opponent->inGame = true;
    return true;
  }
  
  return false;
}

bool leaveGame(PlayerList *list, int playerId) {
  Player *player = findPlayerById(list, playerId); // TODO: error handling
  
  if ((!player) || (!player->opponent)) {
    return false;
  }
  
  Player *opponent = findPlayerByName(list, player->opponent); // TODO: error handling
  
  if (opponent && opponent->opponent) {
    if (strncmp(player->name, opponent->opponent, 5) == 0) {
      free(opponent->opponent);
      opponent->opponent = NULL;
      opponent->inGame = false;
    }
  }
  
  free(player->opponent);
  player->opponent = NULL;
  player->inGame = false;
  
  return true;
}

bool updatePosition(Player *player, char position) {
  if (player && position >= '0' && position <= '9') {
    player->position = position - '0';
    printf("player %d has new position %d\n", player->id, player->position);
    return true;
  }
  return false;
}